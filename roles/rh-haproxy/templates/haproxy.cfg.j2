# This file managed by Puppet
global
  daemon  
  group  haproxy
  log  /dev/log local0
  maxconn  10000
  pidfile  /var/run/haproxy.pid
  user  haproxy

defaults
  log  global
  mode  tcp
  retries  3
  timeout  http-request 10s
  timeout  queue 1m
  timeout  connect 10s
  timeout  client 1m
  timeout  server 1m
  timeout  check 10s

listen ceilometer
{% if use_haproxy_ssl_termination %}
  bind {{ ceilometer_public_vip }}:8777 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ ceilometer_public_vip }}:8777
{% endif %}
  bind {{ ceilometer_internal_vip }}:8777
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:8777 check fall 5 inter 2000 rise 2
{% endfor %}

listen cinder
{% if use_haproxy_ssl_termination %}
  bind {{ cinder_public_vip }}:8776 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ cinder_public_vip }}:8776
{% endif %}
  bind {{ cinder_internal_vip }}:8776 

{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:8776 check fall 5 inter 2000 rise 2
{% endfor %}

listen glance_api
{% if use_haproxy_ssl_termination %}
  bind {{ glance_public_vip }}:9292 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ glance_public_vip }}:9292
{% endif %}
  bind {{ glance_internal_vip }}:9292 
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:9292 check fall 5 inter 2000 rise 2
{% endfor %}

listen glance_registry
  bind {{ glance_internal_vip }}:9191 
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:9191 check fall 5 inter 2000 rise 2
{% endfor %}

listen heat_api
{% if use_haproxy_ssl_termination %}
  mode http
  option forwardfor
  reqadd X-Forwarded-Proto:\ https if { ssl_fc }
  bind {{ heat_public_vip }}:8004 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ heat_public_vip }}:8004
{% endif %}
  bind {{ heat_internal_vip }}:8004
  mode http
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:8004 check fall 5 inter 2000 rise 2
{% endfor %}

listen heat_cfn
{% if use_haproxy_ssl_termination %}
  mode http
  option forwardfor
  reqadd X-Forwarded-Proto:\ https if { ssl_fc }
  bind {{ heat_public_vip }}:8000 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ heat_public_vip }}:8000
{% endif %}
  bind {{ heat_internal_vip }}:8000
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:8000 check fall 5 inter 2000 rise 2
{% endfor %}

listen heat_cloudwatch
{% if use_haproxy_ssl_termination %}
  mode http
  option forwardfor
  reqadd X-Forwarded-Proto:\ https if { ssl_fc }
  bind {{ heat_public_vip }}:8003 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ heat_public_vip }}:8003
{% endif %}
  bind {{ heat_internal_vip }}:8003
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:8003 check fall 5 inter 2000 rise 2
{% endfor %}

#listen horizon
#  bind {{ horizon_public_vip }}:80
#  bind {{ horizon_internal_vip }}:80
#  mode http
#  cookie SERVERID insert indirect nocache
#{% for node in controller_nodes %}
#  server {{ node.name }} {{ node.addr_int }}:80 check fall 5 inter 2000 rise 2
#{% endfor %}
#########################
{% if use_haproxy_ssl_termination %}
frontend vip-horizon-http-pub
    mode http
    bind {{ horizon_public_vip }}:80
    redirect scheme https if !{ ssl_fc }

frontend vip-horizon-https-pub
    mode http
    bind {{ horizon_public_vip }}:443 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
    default_backend horizon

{% else %}
frontend vip-horizon-pub
    mode http
    bind {{ horizon_public_vip }}:80
    timeout client 180s
    default_backend horizon
{% endif %}

{% if horizon_public_vip != horizon_internal_vip %}
frontend vip-horizon-int
    mode http
    bind {{ horizon_internal_vip }}:80
    timeout client 180s
    default_backend horizon
{% endif %}

backend horizon
    mode http
    balance roundrobin
    timeout server 180s
    cookie SERVERID insert indirect nocache
{% for node in controller_nodes %}
    server {{ node.name }} {{ node.addr_int }}:80 check fall 5 inter 2000 rise 2
#    server {{ node.name }} {{ node.addr_int }}:80 check inter 1s cookie {{ node.name }}
{% endfor %}

#########################
listen keystone_admin
  bind {{ keystone_public_vip }}:35357
  bind {{ keystone_internal_vip }}:35357
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:35357 check fall 5 inter 2000 rise 2
{% endfor %}

listen keystone_public
{% if use_haproxy_ssl_termination %}
  bind {{ keystone_public_vip }}:5000 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ keystone_public_vip }}:5000
{% endif %}
  bind {{ keystone_internal_vip }}:5000
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:5000 check fall 5 inter 2000 rise 2
{% endfor %}

listen mysql
  bind {{ db_vip }}:3306
  option tcpka
  option httpchk
  stick on dst
  stick-table type ip size 1000
  timeout client 0
  timeout server 0
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:3306 backup check fall 5 inter 2000 on-marked-down shutdown-sessions port 9200 rise 2
{% endfor %}

listen neutron
{% if use_haproxy_ssl_termination %}
  bind {{ neutron_public_vip }}:9696 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ neutron_public_vip }}:9696
{% endif %}
  bind {{ neutron_internal_vip }}:9696
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:9696 check fall 5 inter 2000 rise 2
{% endfor %}

listen nova_ec2
{% if use_haproxy_ssl_termination %}
  bind {{ nova_public_vip }}:8773 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ nova_public_vip }}:8773
{% endif %}
  bind {{ nova_internal_vip }}:8773
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:8773 check fall 5 inter 2000 rise 2
{% endfor %}

listen nova_metadata
  bind {{ nova_internal_vip }}:8775
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:8775 check fall 5 inter 2000 rise 2
{% endfor %}

listen nova_novncproxy
{% if use_haproxy_ssl_termination %}
  bind {{ nova_public_vip }}:6080 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ nova_public_vip }}:6080
{% endif %}
  bind {{ nova_internal_vip }}:6080
  balance source
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:6080 check fall 5 inter 2000 rise 2
{% endfor %}

listen nova_osapi
{% if use_haproxy_ssl_termination %}
  bind {{ nova_public_vip }}:8774 ssl crt /etc/pki/haproxy/cert.pem no-sslv3
{% else %}
  bind {{ nova_public_vip }}:8774
{% endif %}
  bind {{ nova_internal_vip }}:8774 
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:8774 check fall 5 inter 2000 rise 2
{% endfor %}

listen redis
  bind {{ redis_vip }}:6379
  balance first
  option tcp-check
  tcp-check send info\ replication\r\n
  tcp-check expect string role:master
  timeout client 0
  timeout server 0
{% for node in controller_nodes %}
  server {{ node.name }} {{ node.addr_int }}:6379 check fall 5 inter 2000 rise 2
{% endfor %}  

listen  stats   {{ internal_ip }}:1936
        mode            http
        log             global

        maxconn 10

        clitimeout      100s
        srvtimeout      100s
        contimeout      100s
        timeout queue   100s

        stats enable
        stats hide-version
        stats refresh 30s
        stats show-node
        stats auth admin:nada@nada
        stats uri  /haproxy?stats
